@page "/transactions"
@attribute [Authorize]
@using Microsoft.AspNetCore.Identity
@using FinanceDashboard.Web.Data.Entities
@using FinanceDashboard.Web.Services
@using FinanceDashboard.Web.Components.Transactions
@inject ITransactionService TransactionService
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>Transactions</PageTitle>

<div class="container-fluid px-2 px-md-4">
    <!-- Header - Stack on mobile -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 gap-2">
        <h3 class="mb-0">&#x1F4B3; Transactions</h3>
        <button class="btn btn-primary" @onclick="OpenAddModal">
            &#x2795; Add Transaction
        </button>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show py-2">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show py-2">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- Filters - Collapsible on mobile -->
    <div class="card mb-3">
        <div class="card-body py-2 px-3">
            <div class="row g-2">
                <div class="col-6 col-md-3">
                    <label class="form-label small mb-1">Type</label>
                    <select class="form-select form-select-sm" @onchange="OnTypeFilterChanged">
                        <option value="">All Types</option>
                        <option value="1">&#x1F4B0; Income</option>
                        <option value="2">&#x1F4B8; Expense</option>
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label small mb-1">From</label>
                    <input type="date" class="form-control form-control-sm" @bind="startDate" @bind:after="LoadTransactions" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label small mb-1">To</label>
                    <input type="date" class="form-control form-control-sm" @bind="endDate" @bind:after="LoadTransactions" />
                </div>
                <div class="col-6 col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-secondary btn-sm w-100" @onclick="ClearFilters">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction List -->
    <div class="card" style="min-height: 400px;">
        <div class="card-body p-2 p-md-3">
            @if (isLoading || transactions == null)
            {
                <!-- Loading skeleton -->
                <div class="py-3">
                    @for (int i = 0; i < 5; i++)
                    {
                        <div class="d-flex align-items-center mb-3">
                            <div class="loading-placeholder me-3" style="width: 80px; height: 20px;"></div>
                            <div class="loading-placeholder me-3 flex-grow-1" style="height: 20px;"></div>
                            <div class="loading-placeholder me-3" style="width: 60px; height: 20px;"></div>
                            <div class="loading-placeholder" style="width: 80px; height: 20px;"></div>
                        </div>
                    }
                </div>
            }
            else
            {
                <TransactionList 
                    Transactions="@transactions" 
                    OnEdit="OpenEditModal" 
                    OnDelete="OpenDeleteConfirmation" />
            }
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<TransactionForm 
    IsVisible="@showFormModal" 
    IsEdit="@isEditMode"
    Model="@formModel"
    Categories="@categories"
    OnClose="CloseFormModal"
    OnSubmit="HandleFormSubmit" />

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">&#x26A0;&#xFE0F; Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this transaction?</p>
                    @if (transactionToDelete != null)
                    {
                        <div class="alert alert-light">
                            <strong>@transactionToDelete.Category?.Icon @transactionToDelete.Category?.Name</strong><br />
                            <span class="@(transactionToDelete.Type == TransactionType.Income ? "text-success" : "text-danger")">
                                @(transactionToDelete.Type == TransactionType.Income ? "+" : "-")$@transactionToDelete.Amount.ToString("N2")
                            </span>
                            on @transactionToDelete.Date.ToString("MMM dd, yyyy")
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal" disabled="@isDeleting">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
private List<Transaction>? transactions;
private List<Category> categories = new();
private string? userId;
private bool isLoading = true;
private bool hasInitialized = false;
private string? successMessage;
private string? errorMessage;

// Filter state
private TransactionType? typeFilter;
private DateTime? startDate;
private DateTime? endDate;

// Form modal state
private bool showFormModal = false;
private bool isEditMode = false;
private TransactionForm.TransactionFormModel formModel = new();

// Delete modal state
private bool showDeleteModal = false;
private bool isDeleting = false;
private Transaction? transactionToDelete;

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender && !hasInitialized)
    {
        hasInitialized = true;
            
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            categories = await TransactionService.GetAllCategoriesAsync();
            await LoadTransactions();
            StateHasChanged();
        }
    }
}

private async Task LoadTransactions()
{
    if (string.IsNullOrEmpty(userId)) return;

    isLoading = true;
    transactions = null; // Clear previous data
    StateHasChanged();
        
    try
    {
        // Run data fetch and minimum delay in parallel
        var dataTask = TransactionService.GetUserTransactionsAsync(userId, typeFilter, startDate, endDate);
        var delayTask = Task.Delay(400); // Minimum skeleton display time
            
        await Task.WhenAll(dataTask, delayTask);
        transactions = dataTask.Result;
    }
    catch (Exception ex)
    {
        errorMessage = "Failed to load transactions.";
        transactions = new();
    }
    finally
    {
        isLoading = false;
    }
}

    private async Task OnTypeFilterChanged(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value?.ToString()))
        {
            typeFilter = null;
        }
        else
        {
            typeFilter = (TransactionType)int.Parse(e.Value.ToString()!);
        }
        await LoadTransactions();
    }

    private async Task ClearFilters()
    {
        typeFilter = null;
        startDate = null;
        endDate = null;
        await LoadTransactions();
    }

    private void OpenAddModal()
    {
        isEditMode = false;
        formModel = new TransactionForm.TransactionFormModel
        {
            Date = DateTime.Today,
            Type = TransactionType.Expense
        };
        showFormModal = true;
    }

    private void OpenEditModal(Transaction transaction)
    {
        isEditMode = true;
        formModel = new TransactionForm.TransactionFormModel
        {
            Id = transaction.Id,
            Amount = transaction.Amount,
            Type = transaction.Type,
            CategoryId = transaction.CategoryId,
            Date = transaction.Date,
            Description = transaction.Description
        };
        showFormModal = true;
    }

    private void CloseFormModal()
    {
        showFormModal = false;
    }

    private async Task HandleFormSubmit(TransactionForm.TransactionFormModel model)
    {
        if (string.IsNullOrEmpty(userId)) return;

        try
        {
            if (isEditMode)
            {
                var transaction = new Transaction
                {
                    Id = model.Id,
                    UserId = userId,
                    Amount = model.Amount,
                    Type = model.Type,
                    CategoryId = model.CategoryId,
                    Date = model.Date,
                    Description = model.Description
                };
                await TransactionService.UpdateAsync(transaction);
                successMessage = "Transaction updated successfully!";
            }
            else
            {
                var transaction = new Transaction
                {
                    UserId = userId,
                    Amount = model.Amount,
                    Type = model.Type,
                    CategoryId = model.CategoryId,
                    Date = model.Date,
                    Description = model.Description
                };
                await TransactionService.CreateAsync(transaction);
                successMessage = "Transaction added successfully!";
            }

            showFormModal = false;
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to save transaction. Please try again.";
        }
    }

    private void OpenDeleteConfirmation(Transaction transaction)
    {
        transactionToDelete = transaction;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        transactionToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (transactionToDelete == null || string.IsNullOrEmpty(userId)) return;

        isDeleting = true;
        try
        {
            await TransactionService.DeleteAsync(transactionToDelete.Id, userId);
            successMessage = "Transaction deleted successfully!";
            showDeleteModal = false;
            transactionToDelete = null;
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to delete transaction.";
        }
        finally
        {
            isDeleting = false;
        }
    }
}
